.step(data-title='User Story: Manage Subscriptions', data-file='MarketingNotifications/Controllers/NotificationsController.cs')
  h2 User Story: Manage Subscriptions
  blockquote As a User, I would like to manage my subscription status via text message.
  :markdown
    We want to provide the user with two SMS commands to manage their subscription status: `subscribe` and `unsubscribe`.  These commands will toggle a boolean flag for their `Subscriber` record in the database, and will determine whether or not they receive messages from our marketing campaign. Because we're not jerks, we don't opt them in automatically - rather, we have them confirm that they want to receive messages from us first.

    To make this happen, we will need to update the controller logic which handles the incoming text message to do a couple things:

    * If the texter is a person already in the database, parse the message they sent to see if it's a command we recognize
    * If it is a `subscribe` or `unsubscribe` command, update their subscription status in the database
    * If it is a command we don't recognize, send them a message explaining available commands

    Let's go back into our controller function to see how this works.

.step(data-title='Processing an Incoming Message', data-file='MarketingNotifications/Controllers/NotificationsController.cs', data-highlight='82-104')
  :markdown
    ## Processing an Incoming Message

    This private method handles parsing the incoming message from the user and executing conditional logic to see if they have issued us a command we recognize. It's executed after we have already hit the database once to retrieve the current `Subscriber` model.

.step(data-title='Handling a Subscription Command', data-file='MarketingNotifications/Controllers/NotificationsController.cs', data-highlight='86-97')
  :markdown
    ## Handling a Subscription Command

    If the user has texted `subscribe` or `stahp`, we will update their subscription status in the database. We will then respond to them via SMS with the opposite command to either opt in to updates or opt out.
    
    Note: We have chosen not to use `unsubscribe` as a keyword because it opts the texter out of receiving future text messages from our Twilio number. More details on this can be found [here](https://www.twilio.com/help/faq/sms/does-twilio-support-stop-block-and-cancel-aka-sms-filtering).

.step(data-title='Listing Available Commands', data-file='MarketingNotifications/Controllers/NotificationsController.cs', data-highlight='98-101')
  :markdown
    ## Listing Available Commands

    If they texted in something we don't recognize, we respond to them with a listing of all known commands. We could take this further and implement "help" text for each command, but in this simple use case the commands should be self-explanatory.

.step(data-title='Responding with TwiML', data-file='MarketingNotifications/Controllers/NotificationsController.cs', data-highlight='106-111')
  :markdown
    ## Responding with TwiML

    The Twilio .NET library includes a subclass of `ActionResult` called `TwiMLResult` that can be returned from our `NotificationsController` since it subclasses `TwilioController`. This makes it easy to generate a TwiML response to return from our `/Incoming` method. We create a `GenerateTwiML` method our controller can call to close out the interaction with our incoming message.
    
    That's it for the user-facing commands! Now, we need to provide our marketing team with an interface to send messages out to all subscribers. Let's take a look at that next.
